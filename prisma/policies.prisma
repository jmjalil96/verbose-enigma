// =============================================================================
// Enums
// =============================================================================

enum InsurerType {
  MEDICINA_PREPAGADA
  COMPANIA_DE_SEGUROS
}

enum PolicyType {
  HEALTH
  LIFE
  ACCIDENTS
}

enum PolicyStatus {
  PENDING
  ACTIVE
  SUSPENDED
  EXPIRED
  CANCELLED
}

enum CoverageType {
  INDIVIDUAL
  INDIVIDUAL_PLUS_1
  FAMILY
}

enum EnrollmentStartReason {
  NEW_HIRE
  OPEN_ENROLLMENT
  QUALIFYING_EVENT
  REINSTATEMENT
  OTHER
}

enum EnrollmentEndReason {
  TERMINATION
  RESIGNATION
  RETIREMENT
  DEATH
  POLICY_CANCELLED
  OTHER
}

// =============================================================================
// Models
// =============================================================================

model Insurer {
  id      String  @id @default(cuid())
  name    String  @unique
  code    String? @unique
  email   String?
  phone   String?
  website String?

  type InsurerType

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  policies Policy[]
  invoices Invoice[]
  files    InsurerFile[]

  @@index([isActive])
  @@map("insurers")
}

model Policy {
  id           String @id @default(cuid())
  policyNumber String

  clientId  String
  client    Client  @relation(fields: [clientId], references: [id])
  insurerId String
  insurer   Insurer @relation(fields: [insurerId], references: [id])

  type   PolicyType?
  status PolicyStatus @default(PENDING)

  startDate DateTime @db.Date
  endDate   DateTime @db.Date

  ambulatoryCoinsurancePct  Decimal? @db.Decimal(5, 2)
  hospitalaryCoinsurancePct Decimal? @db.Decimal(5, 2)
  maternityCost             Decimal? @db.Decimal(12, 2)

  tPremium      Decimal? @db.Decimal(12, 2)
  tplus1Premium Decimal? @db.Decimal(12, 2)
  tplusfPremium Decimal? @db.Decimal(12, 2)

  benefitsCostPerPerson Decimal? @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cancellationReason String?
  cancelledAt        DateTime?

  enrollments       PolicyEnrollment[]
  claims            Claim[]
  history           PolicyHistory[]
  invoicePolicies   InvoicePolicy[]
  discrepancyCauses InvoiceDiscrepancyCause[]
  files             PolicyFile[]

  @@unique([policyNumber, insurerId])
  @@index([policyNumber])
  @@index([clientId])
  @@index([insurerId])
  @@index([status])
  @@index([startDate, endDate])
  @@map("policies")
}

model PolicyEnrollment {
  id String @id @default(cuid())

  policyId    String
  policy      Policy    @relation(fields: [policyId], references: [id], onDelete: Cascade)
  affiliateId String
  affiliate   Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  coverageType CoverageType?

  startDate   DateTime               @db.Date
  endDate     DateTime?              @db.Date
  startReason EnrollmentStartReason?
  endReason   EnrollmentEndReason?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dependents        EnrollmentDependent[]
  discrepancyCauses InvoiceDiscrepancyCause[]
  files             EnrollmentFile[]

  @@unique([policyId, affiliateId, startDate])
  @@index([policyId])
  @@index([affiliateId])
  @@index([coverageType])
  @@index([startDate])
  @@index([endDate])
  @@map("policy_enrollments")
}

model EnrollmentDependent {
  id String @id @default(cuid())

  enrollmentId String
  enrollment   PolicyEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  dependentId String
  dependent   Affiliate @relation("EnrolledAsDependent", fields: [dependentId], references: [id])

  addedAt   DateTime  @default(now())
  removedAt DateTime?

  createdAt DateTime @default(now())

  @@unique([enrollmentId, dependentId, addedAt])
  @@index([enrollmentId])
  @@index([dependentId])
  @@map("enrollment_dependents")
}

model PolicyHistory {
  id       String @id @default(cuid())
  policyId String
  policy   Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  fromStatus PolicyStatus?
  toStatus   PolicyStatus
  reason     String?
  notes      String?

  createdById String
  createdBy   User     @relation("PolicyHistoryCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  @@index([policyId])
  @@index([createdById])
  @@index([createdAt])
  @@map("policy_history")
}

model InsurerFile {
  id        String  @id @default(cuid())
  insurerId String
  insurer   Insurer @relation(fields: [insurerId], references: [id], onDelete: Cascade)

  fileName    String
  fileSize    Int
  contentType String
  fileKey     String @unique

  deletedAt DateTime?

  createdById String
  createdBy   User     @relation("InsurerFileCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  @@index([insurerId])
  @@index([createdById])
  @@index([deletedAt])
  @@map("insurer_files")
}

model PolicyFile {
  id       String @id @default(cuid())
  policyId String
  policy   Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  fileName    String
  fileSize    Int
  contentType String
  fileKey     String @unique

  deletedAt DateTime?

  createdById String
  createdBy   User     @relation("PolicyFileCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  @@index([policyId])
  @@index([createdById])
  @@index([deletedAt])
  @@map("policy_files")
}

model EnrollmentFile {
  id           String           @id @default(cuid())
  enrollmentId String
  enrollment   PolicyEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  fileName    String
  fileSize    Int
  contentType String
  fileKey     String @unique

  deletedAt DateTime?

  createdById String
  createdBy   User     @relation("EnrollmentFileCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  @@index([enrollmentId])
  @@index([createdById])
  @@index([deletedAt])
  @@map("enrollment_files")
}
