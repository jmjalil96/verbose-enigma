enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
  DOMESTIC_PARTNERSHIP
}

enum DependentRelationship {
  SPOUSE
  CHILD
  PARENT
  SIBLING
  OTHER
}

model Affiliate {
  id String @id @default(cuid())

  // Identity
  firstName      String
  lastName       String
  documentType   String?
  documentNumber String?

  // Contact
  email String?
  phone String?

  // Demographics
  dateOfBirth   DateTime?
  gender        Gender?
  maritalStatus MaritalStatus?

  // Dependent relationship (global, single source of truth)
  primaryAffiliateId String?
  primaryAffiliate   Affiliate?  @relation("AffiliateDependents", fields: [primaryAffiliateId], references: [id], onDelete: SetNull)
  dependents         Affiliate[] @relation("AffiliateDependents")

  relationship DependentRelationship?

  // Ownership
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  // Optional portal access
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invitation Invitation?

  // Claims (as policy holder or patient)
  claimsAsAffiliate Claim[] @relation("ClaimAffiliate")
  claimsAsPatient   Claim[] @relation("ClaimPatient")

  // Policy enrollments
  enrollments         PolicyEnrollment[]
  enrolledAsDependent EnrollmentDependent[] @relation("EnrolledAsDependent")

  // Files
  files AffiliateFile[]

  @@index([clientId])
  @@index([userId])
  @@index([primaryAffiliateId])
  @@index([documentNumber])
  @@index([lastName, firstName])
  @@index([isActive])
  @@map("affiliates")
}

model AffiliateFile {
  id          String    @id @default(cuid())
  affiliateId String
  affiliate   Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  fileName    String
  fileSize    Int
  contentType String
  fileKey     String @unique

  deletedAt DateTime?

  createdById String
  createdBy   User     @relation("AffiliateFileCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  @@index([affiliateId])
  @@index([createdById])
  @@index([deletedAt])
  @@map("affiliate_files")
}
